<!doctype html>
    <html lang="en">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"/></script>
      <title>IMDb Movie Rating and Genre Classifier</title>
      <meta name="description" content="IMDb Movie Rating and Genre Classifier">
  </head>
  <body>
   <div class="container mt-3">
    <h1>IMDb Movie Rating and Genre Classifier</h1>
    <label for="image-file">Upload a picture of a movie poster:</label>
    <br>
    <input type="file"
    id="image-file" name="image-file"
    capture="environment" accept="image/*">
    <div>
        <img id="image-preview" src="img/DogProfile.svg" height="297 px" width="200 px">
        <p id="prediction-text">No Movie Poster Selected...</p>
    </div>
    <script>
  const classificationEndpoint = "https://hf.space/embed/hh871/movie_genre_classifier/+/api/predict"

  function dataUrlFromFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            resolve(event.target.result);
        };
        reader.readAsDataURL(file);
    });
}

// Send the image to the server for classification
function classifyImage(dataUrl) {
    const jsonData = {"data": [dataUrl]}
    const jsonDataString = JSON.stringify(jsonData);
    const headers = new Headers();
    headers.append('Content-Type', 'application/json');
    const request = new Request(classificationEndpoint, {
        method: 'POST',
        headers: headers,
        body: jsonDataString
    });
    return fetch(request).then(response => response.json());
}

function formatAsPercentage(number, digits) {
    return (number * 100).toFixed(digits) + "%";
}

function formatPredictionText(prediction) {
    const predictionData = prediction.data[0];
    const label0 = predictionData.label;
    const label1 = predictionData.confidences[1].label;
    const label2 = predictionData.confidences[2].label;
    const confidence0 = predictionData.confidences[0]['confidence']
    const confidence1 = predictionData.confidences[1]['confidence']
    const confidence2 = predictionData.confidences[2]['confidence']
    const output_str = `${label0}: ${formatAsPercentage(confidence0, 1)} confidence
    ${label1}: ${formatAsPercentage(confidence1, 1)} confidence
    ${label2}: ${formatAsPercentage(confidence2, 1)} confidence`
    return output_str;
}

// When an image is selected, update the UI and get the prediction.
const selectElement = document.getElementById('image-file');
selectElement.addEventListener('change', (event) => {
    const files = event.target.files;
    document.getElementById('prediction-text').innerText = 'Processing image...'
    if (files.length > 0) {
        const file = files[0];

        // Set image-preview to file data
        dataUrlFromFile(file).then((dataUrl) => {
            document.getElementById('image-preview').src = dataUrl;

            // Update the prediction text with the classification result
            classifyImage(dataUrl).then((prediction) => {
                document.getElementById('prediction-text').innerText = formatPredictionText(prediction);
            });
        });
    }
});
</script>
</body>
</html>
